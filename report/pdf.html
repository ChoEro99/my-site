<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‹¬ì¸µ ë¶„ì„ PDF</title>
<link rel="stylesheet" href="/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head><body>
<div class="wrap"><div class="grid" style="grid-template-columns:minmax(0,1fr)">
<main class="card hero">
  <h1 id="title">ë¦¬í¬íŠ¸ ì¤€ë¹„ ì¤‘â€¦</h1>
  <p id="meta"></p>
  <div class="premium-upsell">
    <p class="premium-label">ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°</p>
    <ul id="reportList"></ul>
  </div>
  <div class="btns">
    <button class="primary" id="btnPdf">PDF ë‹¤ìš´ë¡œë“œ</button>
    <a class="pill" href="/">ğŸ  í™ˆ</a>
  </div>
</main></div></div>
<script>
(function(){
  const p = new URLSearchParams(location.search);
  const test = p.get('test') || '';
  const result = p.get('result') || '';
  const plan = p.get('plan') || 'starter';
  const draft = p.get('draft') || `${test}:${result}:${plan}`;

  const purchase = JSON.parse(localStorage.getItem(`reportPurchase:${draft}`) || 'null');
  if (!purchase?.paid) {
    alert('ê²°ì œ ì •ë³´ê°€ í™•ì¸ë˜ì§€ ì•Šì•„ ë¦¬í¬íŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    location.href = '/';
    return;
  }

  const draftData = JSON.parse(localStorage.getItem(`reportDraft:${draft}`) || 'null');
  const resultTitle = draftData?.resultTitle || result || 'ê²°ê³¼';
  const testTitle = draftData?.testTitle || test || 'í…ŒìŠ¤íŠ¸';
  const data = draftData?.result || {};

  document.getElementById('title').textContent = `${resultTitle} ${plan === 'full' ? 'Full' : 'Starter'} PDF ë¦¬í¬íŠ¸`;
  document.getElementById('meta').textContent = `${testTitle} Â· ê²°ì œë²ˆí˜¸ ${purchase.paymentId}`;

  const items = [
    `ìš”ì•½: ${data.desc || '-'}`,
    `ê°•ì : ${(data.strengths || []).join(', ') || '-'}`,
    `ì£¼ì˜: ${(data.pitfalls || []).join(', ') || '-'}`,
    `ë£¨í‹´: ${(data.routine || []).join(', ') || '-'}`
  ];
  if (plan === 'full') {
    items.push(`ì„ í˜¸ ìœ í˜• í•´ì„: ${resultTitle}ì˜ ê´€ê³„/í–‰ë™ íŒ¨í„´ì„ êµ¬ì²´ì ìœ¼ë¡œ í•´ì„í•©ë‹ˆë‹¤.`);
    items.push(`ëŒ€ì¡°/ë¹„êµ: ë‹¤ë¥¸ ì£¼ìš” ìœ í˜•ê³¼ì˜ ì°¨ì´ì ì„ ë¹„êµí•´ ê°œì„  í¬ì¸íŠ¸ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.`);
  }
  const ul = document.getElementById('reportList');
  ul.innerHTML = items.map(x => `<li>${x}</li>`).join('');

  document.getElementById('btnPdf').onclick = function(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a4' });
    let y = 15;
    doc.setFontSize(16);
    doc.text(`${resultTitle} ${plan === 'full' ? 'Full' : 'Starter'} PDF ë¦¬í¬íŠ¸`, 12, y);
    y += 8;
    doc.setFontSize(10);
    doc.text(`${testTitle} | payment: ${purchase.paymentId}`, 12, y);
    y += 10;

    const lines = items.flatMap((line) => doc.splitTextToSize(`- ${line}`, 180));
    lines.forEach((line) => {
      if (y > 280) {
        doc.addPage();
        y = 15;
      }
      doc.text(line, 12, y);
      y += 6;
    });
    doc.save(`${test}_${result}_${plan}_report.pdf`);
  };
})();
</script>
</body></html>
