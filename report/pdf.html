<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‹¬ì¸µ ë¶„ì„ PDF</title>
<link rel="stylesheet" href="/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head><body>
<div class="wrap"><div class="grid" style="grid-template-columns:minmax(0,1fr)">
<main class="card hero" id="reportCard">
  <h1 id="title">ë¦¬í¬íŠ¸ ì¤€ë¹„ ì¤‘â€¦</h1>
  <p id="meta"></p>
  <div class="premium-upsell">
    <p class="premium-label">ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°</p>
    <ul id="reportList"></ul>
  </div>
  <div class="btns">
    <button class="primary" id="btnPdf">PDF ë‹¤ìš´ë¡œë“œ</button>
    <a class="pill" href="/">ğŸ  í™ˆ</a>
  </div>
</main></div></div>
<script>
(function(){
  const p = new URLSearchParams(location.search);
  const test = p.get('test') || '';
  const result = p.get('result') || '';
  const plan = p.get('plan') || 'starter';
  const draft = p.get('draft') || `${test}:${result}:${plan}`;

  const purchase = JSON.parse(localStorage.getItem(`reportPurchase:${draft}`) || 'null');
  if (!purchase?.paid) {
    alert('ê²°ì œ ì •ë³´ê°€ í™•ì¸ë˜ì§€ ì•Šì•„ ë¦¬í¬íŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    location.href = '/';
    return;
  }

  const draftData = JSON.parse(localStorage.getItem(`reportDraft:${draft}`) || 'null');
  const resultTitle = draftData?.resultTitle || result || 'ê²°ê³¼';
  const testTitle = draftData?.testTitle || test || 'í…ŒìŠ¤íŠ¸';
  const data = draftData?.result || {};

  document.getElementById('title').textContent = `${resultTitle} ${plan === 'full' ? 'Full' : 'Starter'} PDF ë¦¬í¬íŠ¸`;
  document.getElementById('meta').textContent = `${testTitle} Â· ê²°ì œë²ˆí˜¸ ${purchase.paymentId}`;

  const strengths = Array.isArray(data.strengths) ? data.strengths : [];
  const pitfalls = Array.isArray(data.pitfalls) ? data.pitfalls : [];
  const routine = Array.isArray(data.routine) ? data.routine : [];

  const buildStarterItems = () => {
    const summary = data.desc || `${resultTitle} íƒ€ì…ì€ ì‹¤í–‰ë ¥ê³¼ ì ì¬ë ¥ì´ ê· í˜•ì„ ì´ë£¨ëŠ” í¸ì…ë‹ˆë‹¤.`;
    const leadStrength = strengths[0] || 'ë¹ ë¥¸ ìƒí™© íŒŒì•…';
    const supportStrength = strengths[1] || 'ì¼ê´€ëœ ì‹¤í–‰ë ¥';
    const leadPitfall = pitfalls[0] || 'ì´ˆë°˜ ê³¼ì—´ í›„ í˜ì´ìŠ¤ ì €í•˜';
    const supportPitfall = pitfalls[1] || 'ìš°ì„ ìˆœìœ„ í˜¼ì„ ';
    const leadRoutine = routine[0] || 'í•µì‹¬ 1ê°€ì§€ë¶€í„° ì‹œì‘í•˜ê¸°';
    const supportRoutine = routine[1] || 'ë§ˆê° 10ë¶„ íšŒê³  ì •ë¦¬';

    return [
      `ìš”ì•½ ì§„ë‹¨: ${summary}`,
      `ê¸°ë³¸ ì‹¬ì¸µ ë¶„ì„ â‘  ê°•ì  êµ¬ì¡°: í•µì‹¬ ê°•ì ì€ '${leadStrength}'ì´ë©°, '${supportStrength}'ê°€ ì´ë¥¼ ë³´ì™„í•©ë‹ˆë‹¤. ì´ ì¡°í•©ì€ ì‹œì‘ ì†ë„ì™€ ìœ ì§€ë ¥ì„ ë™ì‹œì— ëŒì–´ì˜¬ë¦¬ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.`,
      `ê¸°ë³¸ ì‹¬ì¸µ ë¶„ì„ â‘¡ ë¦¬ìŠ¤í¬ êµ¬ì¡°: '${leadPitfall}' ìƒí™©ì—ì„œ ì„±ê³¼ í¸ì°¨ê°€ ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ '${supportPitfall}'ê°€ ê²¹ì¹˜ë©´ íë¦„ì´ ëŠê¸°ê¸° ì‰¬ì›Œ ì‚¬ì „ ì ê²€ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.`,
      `ê¸°ë³¸ ì‹¬ì¸µ ë¶„ì„ â‘¢ ì‹¤í–‰ ë£¨í‹´: '${leadRoutine}'ë¥¼ ì•µì»¤ ìŠµê´€ìœ¼ë¡œ ë‘ê³  '${supportRoutine}'ë¥¼ ë³´ì¡° ë£¨í‹´ìœ¼ë¡œ ì—°ê²°í•˜ë©´ ì‹¤ì²œìœ¨ì´ ì•ˆì •ì ìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.`,
      `ì˜ˆì‹œ ì‚¬ë¡€ A(ì˜ í’€ë¦´ ë•Œ): í•´ì•¼ í•  ì¼ì´ ë§ì•„ë„ ìš°ì„ ìˆœìœ„ë¥¼ ë¹ ë¥´ê²Œ ì¡ê³  ë°”ë¡œ ì°©ìˆ˜í•´, ì´ˆë°˜ 30ë¶„ ë‚´ ì„±ê³¼ë¥¼ ë§Œë“­ë‹ˆë‹¤.`,
      `ì˜ˆì‹œ ì‚¬ë¡€ B(í”ë“¤ë¦´ ë•Œ): ì¼ì •ì´ ê¼¬ì´ë©´ ì™„ë²½í•˜ê²Œ ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë‹¤ ì§€ì—°ì´ ìƒê¹ë‹ˆë‹¤. ì´ë•ŒëŠ” ë¶„ëŸ‰ì„ 50%ë¡œ ì¤„ì—¬ ì¬ì°©ìˆ˜í•˜ë©´ íšŒë³µì´ ë¹ ë¦…ë‹ˆë‹¤.`
    ];
  };

  const items = buildStarterItems();
  if (plan === 'full') {
    const preferredType = strengths[0] ? `${strengths[0]}ì´(ê°€) ê°•í•œ í˜‘ì—…í˜•` : 'ëª©í‘œ ëª…í™•í˜•';
    const compareType = pitfalls[0] ? `${pitfalls[0]} ë¯¼ê°í˜•` : 'ì¦‰í¥ ë°˜ì‘í˜•';
    items.push(
      `ì„ í˜¸ ìœ í˜•(ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” íƒ€ì…): '${preferredType}'ê³¼ ê¶í•©ì´ ì¢‹ìŠµë‹ˆë‹¤. ëª…í™•í•œ ê¸°ì¤€ì„ ì œì‹œí•´ ì£¼ëŠ” ì‚¬ëŒ/í™˜ê²½ê³¼ í•¨ê»˜í•  ë•Œ ì‹¤í–‰ ì§€ì†ë ¥ì´ ì»¤ì§‘ë‹ˆë‹¤.`,
      `ë‚´ ê°œì„  í¬ì¸íŠ¸ â‘ : '${pitfalls[0] || 'ì§‘ì¤‘ë ¥ ë¶„ì‚°'}'ì´ ë³´ì´ë©´ ì¦‰ì‹œ í•  ì¼ì„ 1ê°œë¡œ ì¶•ì†Œí•´ ì°©ìˆ˜ ì‹œê°„ì„ 5ë¶„ ì´ë‚´ë¡œ ì œí•œí•˜ì„¸ìš”.`,
      `ë‚´ ê°œì„  í¬ì¸íŠ¸ â‘¡: '${pitfalls[1] || 'ë¦¬ë“¬ ë¶ˆì•ˆì •'}' êµ¬ê°„ì—ì„œëŠ” ê²°ê³¼ ëª©í‘œë³´ë‹¤ ê³¼ì • ëª©í‘œ(íšŸìˆ˜/ì‹œê°„)ë¥¼ ë¨¼ì € ì±„ìš°ëŠ” ë°©ì‹ì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.`,
      `ëŒ€ì¡°/ë¹„êµ: '${resultTitle}'ì€(ëŠ”) ${compareType}ê³¼ ë¹„êµí•´ ì‹œì‘ ì†ë„ëŠ” ë¹ ë¥´ì§€ë§Œ ì¤‘í›„ë°˜ í˜ì´ìŠ¤ ê´€ë¦¬ê°€ ê´€ê±´ì…ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ ë£¨í‹´ì´ ê³ ì •ë˜ë©´ ëˆ„ì  ì„±ê³¼ëŠ” ë” í¬ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.`
    );
  }
  const ul = document.getElementById('reportList');
  ul.innerHTML = items.map(x => `<li>${x}</li>`).join('');

  document.getElementById('btnPdf').onclick = async function(){
    const btn = this;
    btn.disabled = true;
    const prevLabel = btn.textContent;
    btn.textContent = 'PDF ìƒì„± ì¤‘...';

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'p' });

    try {
      const reportCard = document.getElementById('reportCard');
      const canvas = await html2canvas(reportCard, {
        backgroundColor: '#ffffff',
        scale: Math.min(window.devicePixelRatio || 1, 2),
        useCORS: true
      });
      
      const imgData = canvas.toDataURL('image/png');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const imgHeight = (canvas.height * pageWidth) / canvas.width;
      let renderedHeight = 0;

      while (renderedHeight < imgHeight) {
        if (renderedHeight > 0) doc.addPage();
        doc.addImage(imgData, 'PNG', 0, -renderedHeight, pageWidth, imgHeight, undefined, 'FAST');
        renderedHeight += pageHeight;
      }

      doc.save(`${test}_${result}_${plan}_report.pdf`);
    } finally {
      btn.disabled = false;
      btn.textContent = prevLabel;
    }
  };
})();
</script>
</body></html>
