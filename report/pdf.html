<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‹¬ì¸µ ë¶„ì„ PDF</title>
<link rel="stylesheet" href="/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head><body>
<div class="wrap"><div class="grid" style="grid-template-columns:minmax(0,1fr)">
<main class="card hero" id="reportCard">
  <h1 id="title">ë¦¬í¬íŠ¸ ì¤€ë¹„ ì¤‘â€¦</h1>
  <p id="meta"></p>
  <div class="premium-upsell">
    <p class="premium-label">ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°</p>
    <ul id="reportList"></ul>
  </div>
  <div class="btns">
    <button class="primary" id="btnPdf">PDF ë‹¤ìš´ë¡œë“œ</button>
    <a class="pill" href="/">ğŸ  í™ˆ</a>
  </div>
</main></div></div>
<script>
(function(){
  const p = new URLSearchParams(location.search);
  const test = p.get('test') || '';
  const result = p.get('result') || '';
  const plan = p.get('plan') || 'starter';
  const draft = p.get('draft') || `${test}:${result}:${plan}`;

  const purchase = JSON.parse(localStorage.getItem(`reportPurchase:${draft}`) || 'null');
  if (!purchase?.paid) {
    alert('ê²°ì œ ì •ë³´ê°€ í™•ì¸ë˜ì§€ ì•Šì•„ ë¦¬í¬íŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    location.href = '/';
    return;
  }

  const draftData = JSON.parse(localStorage.getItem(`reportDraft:${draft}`) || 'null');
  const resultTitle = draftData?.resultTitle || result || 'ê²°ê³¼';
  const testTitle = draftData?.testTitle || test || 'í…ŒìŠ¤íŠ¸';
  const data = draftData?.result || {};

  document.getElementById('title').textContent = `${resultTitle} ${plan === 'full' ? 'Full' : 'Starter'} PDF ë¦¬í¬íŠ¸`;
  document.getElementById('meta').textContent = `${testTitle} Â· ê²°ì œë²ˆí˜¸ ${purchase.paymentId}`;

  const items = [
    `ìš”ì•½: ${data.desc || '-'}`,
    `ê°•ì : ${(data.strengths || []).join(', ') || '-'}`,
    `ì£¼ì˜: ${(data.pitfalls || []).join(', ') || '-'}`,
    `ë£¨í‹´: ${(data.routine || []).join(', ') || '-'}`
  ];
  if (plan === 'full') {
    items.push(`ì„ í˜¸ ìœ í˜• í•´ì„: ${resultTitle}ì˜ ê´€ê³„/í–‰ë™ íŒ¨í„´ì„ êµ¬ì²´ì ìœ¼ë¡œ í•´ì„í•©ë‹ˆë‹¤.`);
    items.push(`ëŒ€ì¡°/ë¹„êµ: ë‹¤ë¥¸ ì£¼ìš” ìœ í˜•ê³¼ì˜ ì°¨ì´ì ì„ ë¹„êµí•´ ê°œì„  í¬ì¸íŠ¸ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.`);
  }
  const ul = document.getElementById('reportList');
  ul.innerHTML = items.map(x => `<li>${x}</li>`).join('');

  document.getElementById('btnPdf').onclick = async function(){
    const btn = this;
    btn.disabled = true;
    const prevLabel = btn.textContent;
    btn.textContent = 'PDF ìƒì„± ì¤‘...';

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'p' });

    try {
      const reportCard = document.getElementById('reportCard');
      const canvas = await html2canvas(reportCard, {
        backgroundColor: '#ffffff',
        scale: Math.min(window.devicePixelRatio || 1, 2),
        useCORS: true
      });
      
      const imgData = canvas.toDataURL('image/png');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const imgHeight = (canvas.height * pageWidth) / canvas.width;
      let renderedHeight = 0;

      while (renderedHeight < imgHeight) {
        if (renderedHeight > 0) doc.addPage();
        doc.addImage(imgData, 'PNG', 0, -renderedHeight, pageWidth, imgHeight, undefined, 'FAST');
        renderedHeight += pageHeight;
      }

      doc.save(`${test}_${result}_${plan}_report.pdf`);
    } finally {
      btn.disabled = false;
      btn.textContent = prevLabel;
    }
  };
})();
</script>
</body></html>
