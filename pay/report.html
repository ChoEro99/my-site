<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF ë¦¬í¬íŠ¸ ê²°ì œ</title>
<link rel="stylesheet" href="/style.css"/>
<script src="/analytics-consent.js" defer></script>
<script src="/pay-config.js"></script>
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head><body>
<div class="wrap"><div class="grid" style="grid-template-columns:minmax(0,1fr)">
<main class="card hero">
  <h1>ì‹¬ì¸µ ë¶„ì„ PDF ê²°ì œ</h1>
  <p id="paySummary">ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
  <div class="premium-upsell" id="payCard"></div>
  <div class="btns">
    <button class="primary" id="btnPay">ê²°ì œí•˜ê³  PDF ë°›ê¸°</button>
    <a class="pill" href="/">ğŸ  í™ˆ</a>
  </div>
  <p class="note">* PortOne(ì•„ì„í¬íŠ¸) ì„¤ì •ì´ ì—†ìœ¼ë©´ ë°ëª¨ ê²°ì œë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>
</main></div></div>
<script>
(function(){
  const params = new URLSearchParams(location.search);
  const test = params.get('test') || '';
  const result = params.get('result') || '';
  const plan = params.get('plan') || 'starter';
  const draft = params.get('draft') || `${test}:${result}:${plan}`;
  const key = `reportDraft:${draft}`;

  let draftData = null;
  try { draftData = JSON.parse(localStorage.getItem(key) || 'null'); } catch(e) {}

  const prices = {
    starter: Number((window.REPORT_PRICES && window.REPORT_PRICES.starter) || 900),
    full: Number((window.REPORT_PRICES && window.REPORT_PRICES.full) || 1900)
  };
  const amount = prices[plan] || prices.starter;
  const orderName = `${draftData?.resultTitle || result || 'ê²°ê³¼'} ${plan === 'full' ? 'Full' : 'Starter'} PDF`;

  document.getElementById('paySummary').textContent = `${draftData?.testTitle || test} Â· ${orderName}`;
  document.getElementById('payCard').innerHTML = `
    <p class="premium-label">ê²°ì œ ê¸ˆì•¡</p>
    <p class="premium-price">ğŸ’µ ${amount.toLocaleString()}ì›</p>
    <p class="premium-sub">ê²°ì œ ì™„ë£Œ í›„ ë°”ë¡œ PDF ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
  `;

  function goSuccess(paymentId){
    const success = new URL('/pay/success.html', location.origin);
    success.searchParams.set('test', test);
    success.searchParams.set('result', result);
    success.searchParams.set('plan', plan);
    success.searchParams.set('draft', draft);
    success.searchParams.set('paymentId', paymentId || `demo_${Date.now()}`);
    location.href = success.toString();
  }

  document.getElementById('btnPay').onclick = function(){
    const impCode = window.PAY_CONFIG?.portone?.impCode;
    const pg = plan === 'full' ? window.PAY_CONFIG?.portone?.pgFull : window.PAY_CONFIG?.portone?.pgStarter;
    if (!impCode || !pg || !window.IMP) {
      goSuccess();
      return;
    }

    const IMP = window.IMP;
    IMP.init(impCode);
    IMP.request_pay({
      pg,
      pay_method: 'card',
      merchant_uid: `report_${test}_${result}_${plan}_${Date.now()}`,
      name: orderName,
      amount,
      m_redirect_url: location.href
    }, function(rsp){
      if (rsp.success) {
        goSuccess(rsp.imp_uid || rsp.merchant_uid);
      } else {
        const fail = new URL('/pay/fail.html', location.origin);
        fail.searchParams.set('message', rsp.error_msg || 'ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        location.href = fail.toString();
      }
    });
  };
})();
</script>
</body></html>
